<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASUS PM LAB PRO - Wolf Huang</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', 'PingFang TC', 'Microsoft JhengHei', sans-serif; scroll-behavior: smooth; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .interactive-word:hover { background-color: #4f46e5; color: white; border-radius: 4px; }
        .glass-sidebar { background: #0f172a; }
        textarea:focus { outline: none; }
        .item-subject-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem; margin-bottom: 0.75rem; }
        
        /* AI 生成與冷卻遮罩 */
        .ai-loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            z-index: 50;
            border-radius: inherit;
            transition: all 0.4s ease;
        }
        .dark-ai-loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            z-index: 50;
            border-radius: inherit;
            transition: all 0.4s ease;
        }
        .pulse-text { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-hidden text-sm">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const apiKey = ""; 

        // --- 全域定義防止 ReferenceError ---
        const tabsMapping = ["intro", "star", "homebase", "seei", "reverse_qs", "vocabulary"];
        const tabs = [
            { name: "自我介紹", icon: "user", desc: "Core Pitch" },
            { name: "STAR 範例", icon: "star", desc: "Achievements" },
            { name: "困難問題", icon: "shield-alert", desc: "Q&A Defense" },
            { name: "SEE-I 模型", icon: "message-square", desc: "Mental Model" },
            { name: "關鍵反問", icon: "help-circle", desc: "Reverse Qs" },
            { name: "單字庫", icon: "book-open", desc: "Vocab Assets" }
        ];

        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function pcmToWav(pcmBase64, sampleRate = 24000) {
            const byteCharacters = atob(pcmBase64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
            const pcmData = new Uint8Array(byteNumbers);
            const buffer = new ArrayBuffer(44 + pcmData.length);
            const view = new DataView(buffer);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); } };
            writeString(0, 'RIFF'); view.setUint32(4, 32 + pcmData.length, true); writeString(8, 'WAVE');
            writeString(12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, pcmData.length, true);
            pcmData.forEach((byte, i) => view.setUint8(44 + i, byte));
            return new Blob([buffer], { type: 'audio/wav' });
        }

        // --- 全域調度隊列與熔斷標記 ---
        let requestQueue = Promise.resolve();
        let lastRequestTime = 0;
        let globalIsBlocked = false; 
        const MIN_RPM_DELAY = 8000; // 強制 8 秒間隔以避免觸發 429 RPM 限制

        const App = () => {
            const [activeTab, setActiveTab] = useState(0);
            const [isGenerating, setIsGenerating] = useState(false);
            const [apiStatus, setApiStatus] = useState('idle'); // idle, processing, blocked
            const [cooldownSeconds, setCooldownSeconds] = useState(0);
            const [syncTarget, setSyncTarget] = useState(null); 
            const [isPlaying, setIsPlaying] = useState(null);
            const [notification, setNotification] = useState(null);
            const [playbackSpeed, setPlaybackSpeed] = useState(1.0);
            const [appsScriptUrl, setAppsScriptUrl] = useState("");
            const [sheetUrl, setSheetUrl] = useState("");
            const [userApiKey, setUserApiKey] = useState("");
            
            const [systemPrompt, setSystemPrompt] = useState(
                "你是一位資深的 ASUS 全球電商 PM。你的任務是提供翻譯。嚴禁任何前言、解釋或引號。直接輸出翻譯後的原始文字。語氣精煉、具執行力。單字釋義必須使用「繁體中文」。"
            );

            const [data, setData] = useState({
                intro: { zh: "", en: "" },
                star: [],
                homebase: [],
                seei: [],
                reverse_qs: [],
                vocabulary: []
            });

            const notify = (msg, type = 'success') => { setNotification({ message: msg, type }); setTimeout(() => setNotification(null), 5000); };

            // --- 熔斷保護倒數計時 ---
            useEffect(() => {
                let timer;
                if (cooldownSeconds > 0) {
                    timer = setTimeout(() => setCooldownSeconds(prev => prev - 1), 1000);
                } else if (cooldownSeconds === 0 && apiStatus === 'blocked') {
                    setApiStatus('idle');
                    globalIsBlocked = false;
                    notify("冷卻期結束，API 存取已恢復。");
                }
                return () => clearTimeout(timer);
            }, [cooldownSeconds, apiStatus]);

            // --- 執行 AI 請求 ---
            const askAI = async (prompt, asJson = false) => {
                if (globalIsBlocked) throw new Error(`API 冷卻鎖定中，請等候 ${cooldownSeconds} 秒。`);

                const executeRequest = async () => {
                    const now = Date.now();
                    const wait = Math.max(0, MIN_RPM_DELAY - (now - lastRequestTime));
                    if (wait > 0) await new Promise(r => setTimeout(r, wait));

                    setApiStatus('processing');
                    const finalKey = userApiKey || apiKey;
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${finalKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: asJson ? { responseMimeType: "application/json" } : {}
                    };

                    try {
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        lastRequestTime = Date.now();

                        if (res.status === 429) {
                            globalIsBlocked = true;
                            setApiStatus('blocked');
                            setCooldownSeconds(60); 
                            throw new Error("偵測到 429 頻率限制：RPM 上限已達。系統已啟動熔斷保護，請冷卻 60 秒暫停操作。");
                        }

                        if (res.ok) {
                            const result = await res.json();
                            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (text) {
                                setApiStatus('idle');
                                // 移除 Markdown 標籤並去除多餘空格
                                return text.replace(/```json|```/g, "").trim();
                            }
                            throw new Error("AI 回傳內容無效");
                        }
                        
                        const errorData = await res.json();
                        throw new Error(errorData.error?.message || `Error ${res.status}`);
                    } catch (e) {
                        if (!e.message.includes("429")) setApiStatus('idle');
                        throw e;
                    }
                };

                return new Promise((resolve, reject) => {
                    requestQueue = requestQueue.catch(() => {}).then(async () => {
                        try {
                            const result = await executeRequest();
                            resolve(result);
                        } catch (err) {
                            reject(err);
                        }
                    });
                });
            };

            const syncEnglish = async (section, index = null) => {
                if (apiStatus === 'blocked') return notify(`API 熔斷中，請稍候 ${cooldownSeconds} 秒`, "error");
                
                const targetId = index !== null ? `${section}-${index}` : section;
                if (isGenerating) return; 

                setIsGenerating(true);
                setSyncTarget(targetId);

                let prompt = "";
                const isStar = section === 'star';
                
                try {
                    const currentSection = data[section];
                    if (section === 'intro') prompt = `Translate to business English (DIRECT CONTENT ONLY): ${currentSection.zh}`;
                    else if (isStar) prompt = `Translate STAR to business English JSON. NO PREAMBLE. NO EXPLANATION. JSON keys: context, action, result. Input: ${JSON.stringify(currentSection[index].zh)}`;
                    else if (section === 'homebase' || section === 'seei') prompt = `Translate to business English (DIRECT CONTENT ONLY): ${currentSection[index].zh}`;
                    else if (section === 'reverse_qs') prompt = `Translate to professional English (DIRECT CONTENT ONLY): ${currentSection[index].zh}`;

                    const text = await askAI(prompt, isStar);
                    const newData = { ...data };
                    
                    if (section === 'intro') newData.intro.en = text;
                    else if (isStar) {
                        const clean = text.match(/\{[\s\S]*\}/)?.[0] || text;
                        newData.star[index].en = JSON.parse(clean);
                    }
                    else if (section === 'homebase') newData.homebase[index].en = text;
                    else if (section === 'seei') newData.seei[index].en = text;
                    else if (section === 'reverse_qs') newData.reverse_qs[index].en = text;
                    
                    setData(newData); notify("AI 同步成功");
                } catch (e) { 
                    console.error("AI Error:", e); 
                    notify(e.message, "error"); 
                } finally {
                    setIsGenerating(false);
                    setSyncTarget(null);
                }
            };

            const addSpecificWord = async (word) => {
                if (apiStatus === 'blocked') return;
                const clean = word.toLowerCase().replace(/[^a-z]/g, "");
                if (clean.length < 3 || isGenerating) return;
                
                setIsGenerating(true);
                setSyncTarget('vocabulary');
                notify(`處理單字: ${clean}...`, 'info');
                try {
                    const text = await askAI(`Define "${clean}" for PM in Traditional Chinese. Return ONLY JSON {word, zh, desc, difficulty_score}`, true);
                    const cleanJson = text.match(/\{[\s\S]*\}/)?.[0] || text;
                    const json = JSON.parse(cleanJson);
                    const newData = { ...data };
                    const idx = newData.vocabulary.findIndex(v => v.word.toLowerCase() === clean);
                    if (idx > -1) newData.vocabulary[idx].count += 1; else newData.vocabulary.push({ ...json, count: 1 });
                    setData(newData); notify(`「${clean}」已入單字庫`);
                } catch (e) {
                    notify(e.message, "error");
                } finally {
                    setIsGenerating(false);
                    setSyncTarget(null);
                }
            };

            const generateVocabulary = async () => {
                if (isGenerating || apiStatus === 'blocked') return;
                setIsGenerating(true);
                setSyncTarget('vocabulary');
                const allEn = [data.intro.en, ...data.star.flatMap(s => [s.en.context, s.en.action, s.en.result]), ...data.homebase.map(h => h.en), ...data.seei.map(s => s.en), ...data.reverse_qs.map(r => r.en)].filter(Boolean).join(" ");
                const cleanWords = allEn.toLowerCase().replace(/[^a-z ]/g, "").split(/\s+/).filter(w => w.length > 5);
                const uniqueCandidates = [...new Set(cleanWords)].slice(0, 15);
                try {
                    const text = await askAI(`Pick 8 keywords from [${uniqueCandidates.join(",")}] for a PM. Traditional Chinese definitions. Return ONLY JSON array.`, true);
                    const cleanJson = text.match(/\[[\s\S]*\]/)?.[0] || text;
                    const json = JSON.parse(cleanJson);
                    const newData = { ...data };
                    json.forEach(i => { if (!newData.vocabulary.some(v => v.word === i.word)) newData.vocabulary.push({ ...i, count: 1 }); });
                    setData(newData); notify("單字自動生成完成");
                } catch (e) {
                    notify(e.message, "error");
                } finally {
                    setIsGenerating(false);
                    setSyncTarget(null);
                }
            };

            // --- 雲端同步 (僅 GAS) ---
            const handlePull = async (section) => {
                if (!appsScriptUrl) return notify("請輸入 GAS URL", "error");
                try {
                    const res = await fetch(`${appsScriptUrl}?action=pull&section=${section}`);
                    const cloudData = await res.json();
                    if (cloudData) setData(prev => ({ ...prev, [section]: cloudData }));
                    return true;
                } catch (e) { return false; }
            };

            const pullAll = async () => {
                if (!appsScriptUrl) return notify("請輸入 GAS URL", "error");
                notify("資料拉取中...", "info");
                let count = 0;
                for (const section of tabsMapping) {
                    if (await handlePull(section)) count++;
                }
                notify(`同步完成 (${count}/${tabsMapping.length})`);
            };

            const handlePush = async () => {
                if (!appsScriptUrl) return notify("請輸入 GAS URL", "error");
                const section = tabsMapping[activeTab];
                notify(`上傳 ${section} 中...`, "info");
                try {
                    await fetch(appsScriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: "push", section, data: data[section] }) });
                    notify("雲端存檔指令已發送");
                } catch (e) { notify("上傳失敗", "error"); }
            };

            const addItem = (section) => {
                const newData = { ...data };
                if (section === 'star') newData.star.push({ skill: "新案例標題", zh: {context: "", action: "", result: ""}, en: {context: "", action: "", result: ""} });
                else if (section === 'homebase') newData.homebase.push({ q: "新困難問題?", framework: "Framework", zh: "", en: "" });
                else if (section === 'seei') newData.seei.push({ topic: "新主題概念", zh: "", en: "" });
                else if (section === 'reverse_qs') newData.reverse_qs.push({ zh: "新的反問問題?", en: "" });
                setData(newData);
            };

            const deleteItem = (section, index) => { const newData = { ...data }; newData[section].splice(index, 1); setData(newData); };

            const speak = async (text, id) => {
                const finalKey = userApiKey || apiKey;
                if (!finalKey) return notify("等待注入 Key", "error");
                if (isPlaying) return; setIsPlaying(id);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${finalKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: `Say clearly: ${text}` }] }], 
                            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } },
                            model: "gemini-2.5-flash-preview-tts"
                        })
                    });
                    const result = await res.json();
                    const pcm = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (pcm) {
                        const wav = pcmToWav(pcm); 
                        const audio = new Audio(URL.createObjectURL(wav));
                        audio.playbackRate = playbackSpeed; audio.onended = () => setIsPlaying(null); audio.play();
                    } else { setIsPlaying(null); }
                } catch (e) { setIsPlaying(null); }
            };

            const ItemSubject = ({ index, title, onChange, onSync, onDelete }) => (
                <div className="item-subject-row shrink-0">
                    <div className="flex items-start gap-3 flex-1">
                        {index !== undefined && <div className="bg-indigo-600 text-white w-5 h-5 rounded-md flex items-center justify-center font-black text-[9px] mt-1 flex-shrink-0">{index + 1}</div>}
                        <textarea 
                            className="text-sm font-black text-slate-800 bg-transparent border-none p-0 focus:ring-0 w-full resize-none leading-tight" 
                            rows={1}
                            style={{ height: 'auto' }}
                            value={title} 
                            onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }}
                            onChange={(e) => onChange(e.target.value)} 
                        />
                    </div>
                    <div className="flex items-center gap-1.5 flex-shrink-0 mt-0.5">
                        <button disabled={isGenerating || apiStatus === 'blocked'} onClick={onSync} className={`p-1 transition-all ${apiStatus === 'blocked' ? 'text-rose-300' : (isGenerating ? 'text-slate-100' : 'text-slate-300 hover:text-indigo-600')}`}><Icon name="sparkles" size={14}/></button>
                        <button onClick={onDelete} className="text-slate-200 hover:text-rose-500 p-1 transition-all"><Icon name="trash-2" size={14}/></button>
                    </div>
                </div>
            );

            const SectionHeader = ({ title, desc, onSyncAI, onAdd }) => (
                <div className="mb-4 bg-white p-3 rounded-2xl border border-slate-200 shadow-sm animate-in flex flex-col md:flex-row md:items-center justify-between gap-2 shrink-0">
                    <div className="flex items-center gap-2">
                        <div className="w-1 h-5 bg-indigo-600 rounded-full"></div>
                        <div>
                            <h2 className="text-base font-black text-slate-800 tracking-tighter uppercase italic leading-none">{title}</h2>
                            <p className="text-[8px] text-slate-400 font-bold uppercase tracking-widest mt-1.5">{desc}</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-1.5">
                        {onAdd && (
                            <button onClick={onAdd} className="bg-slate-900 text-white px-2.5 py-1.5 rounded-lg text-[9px] font-black flex items-center gap-1 hover:bg-slate-800 active:scale-95 shadow-sm mr-1">
                                <Icon name="plus" size={10}/> ADD
                            </button>
                        )}
                        <button onClick={() => handlePull(tabsMapping[activeTab])} className="bg-white border border-slate-200 text-slate-500 px-2.5 py-1.5 rounded-lg text-[9px] font-black flex items-center gap-1 hover:bg-slate-50 active:scale-95 shadow-sm">
                            <Icon name="download-cloud" size={10}/> PULL
                        </button>
                        <button onClick={handlePush} className="bg-white border border-slate-200 text-indigo-600 px-2.5 py-1.5 rounded-lg text-[9px] font-black flex items-center gap-1 hover:bg-indigo-50 active:scale-95 shadow-sm">
                            <Icon name="upload-cloud" size={10}/> PUSH
                        </button>
                        {onSyncAI && (
                            <button disabled={isGenerating || apiStatus === 'blocked'} onClick={onSyncAI} className={`px-3 py-1.5 rounded-lg shadow-md text-[9px] font-black flex items-center gap-1 transition-all ${apiStatus === 'blocked' ? 'bg-rose-100 text-rose-500 cursor-not-allowed border border-rose-200' : (isGenerating ? 'bg-slate-100 text-slate-400' : 'bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95')}`}>
                                <Icon name={apiStatus === 'blocked' ? "alert-triangle" : "sparkles"} size={10} className={isGenerating ? "animate-spin" : ""}/> 
                                {apiStatus === 'blocked' ? `鎖定中 (${cooldownSeconds}s)` : 'AI SYNC'}
                            </button>
                        )}
                    </div>
                </div>
            );

            const InteractiveText = ({ text }) => {
                if (!text) return <span className="text-slate-300 italic opacity-50 uppercase text-[9px] font-black tracking-widest">Awaiting Intel...</span>;
                return (
                    <div className="leading-relaxed">
                        {text.split(/(\s+|[,.;:!?()])/).map((part, i) => {
                            if (/^[a-zA-Z]{3,}$/.test(part)) {
                                return <span key={i} onClick={() => addSpecificWord(part)} className="cursor-pointer border-b border-dashed border-indigo-200 interactive-word px-0.5 transition-all">{part}</span>;
                            }
                            return <span key={i}>{part}</span>;
                        })}
                    </div>
                );
            };

            const LoadingOverlay = ({ dark = false }) => {
                const isBlocked = apiStatus === 'blocked';
                const label = isBlocked ? `頻率受限，熔斷保護 (${cooldownSeconds}s)...` : "智慧運算中...";
                return (
                    <div className={dark ? "dark-ai-loading-overlay" : "ai-loading-overlay"}>
                        <div className="flex flex-col items-center gap-2">
                            <Icon name={isBlocked ? "shield-alert" : "sparkles"} size={24} className={`${isBlocked ? 'text-rose-400' : 'text-indigo-500'} ${!isBlocked && 'spin-slow'}`} />
                            <span className={`font-black text-[9px] uppercase tracking-tighter pulse-text ${dark ? 'text-indigo-200' : (isBlocked ? 'text-rose-600' : 'text-indigo-600')}`}>{label}</span>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-screen flex flex-col md:flex-row bg-slate-50 overflow-hidden shrink-0">
                    <nav className="w-full md:w-56 glass-sidebar text-slate-400 p-3 flex flex-col h-full z-20 shrink-0 shadow-2xl">
                        <div className="mb-3 flex items-center justify-between px-1 shrink-0">
                            <h1 className="text-base font-black text-white tracking-tighter uppercase leading-none">ASUS PM<br/><span className="text-indigo-500 text-[10px] tracking-[0.2em]">LAB PRO</span></h1>
                            <button onClick={pullAll} className="bg-indigo-600/20 text-indigo-400 p-1.5 rounded-lg hover:bg-indigo-600/40 border border-indigo-500/20 transition-all">
                                <Icon name="refresh-cw" size={12}/>
                            </button>
                        </div>

                        <div className="space-y-1 mb-3 shrink-0">
                            <input type="password" placeholder="API Key" className="w-full bg-slate-800 text-[9px] py-1.5 pl-3 rounded-lg border border-slate-700 outline-none focus:ring-1 focus:ring-indigo-500 text-white" value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} />
                            <input type="text" placeholder="GAS URL" className="w-full bg-slate-800 text-[9px] py-1.5 pl-3 rounded-lg border border-slate-700 outline-none focus:ring-1 focus:ring-indigo-500 text-white" value={appsScriptUrl} onChange={(e) => setAppsScriptUrl(e.target.value)} />
                            <input type="text" placeholder="Sheet URL" className="w-full bg-slate-800 text-[9px] py-1.5 pl-3 rounded-lg border border-slate-700 outline-none focus:ring-1 focus:ring-indigo-500 text-white" value={sheetUrl} onChange={(e) => setSheetUrl(e.target.value)} />
                        </div>

                        {apiStatus === 'blocked' && (
                            <div className="mb-3 bg-rose-950/50 p-2.5 rounded-xl border border-rose-500/30 text-rose-400 flex items-center gap-2 animate-pulse shrink-0">
                                <Icon name="clock" size={12}/>
                                <span className="font-black text-[8px] uppercase tracking-widest">RPM 鎖定: {cooldownSeconds}s</span>
                            </div>
                        )}

                        <div className="mb-3 bg-slate-800/50 p-2 rounded-xl border border-slate-700 shrink-0">
                            <label className="text-[8px] font-black text-indigo-400 uppercase tracking-widest block mb-1 leading-none flex items-center gap-1">
                                <Icon name="settings" size={8}/> AI PROMPT
                            </label>
                            <textarea className="w-full bg-transparent text-[7px] text-slate-300 leading-tight border-none focus:ring-0 p-0 resize-none h-10 custom-scrollbar" value={systemPrompt} onChange={(e) => setSystemPrompt(e.target.value)} />
                        </div>

                        <div className="flex-1 space-y-0.5 overflow-y-auto custom-scrollbar pr-0.5">
                            {tabs.map((tab, idx) => (
                                <button key={idx} onClick={() => setActiveTab(idx)} className={`w-full flex items-center gap-2 px-2.5 py-1.5 rounded-xl transition-all ${activeTab === idx ? "bg-indigo-600 text-white shadow-inner scale-[1.02]" : "hover:bg-slate-800 hover:text-slate-200"}`}>
                                    <Icon name={tab.icon} size={13} />
                                    <span className="font-black text-[9px] uppercase tracking-widest">{tab.name}</span>
                                </button>
                            ))}
                        </div>
                        
                        <div className="mt-3 pt-2 border-t border-slate-800 shrink-0">
                            <div className="grid grid-cols-5 gap-0.5">
                                {[0.5, 0.75, 1.0, 1.25, 1.5].map(s => (
                                    <button key={s} onClick={() => setPlaybackSpeed(s)} className={`text-[8px] font-black py-1.5 rounded-md transition-all ${playbackSpeed === s ? "bg-indigo-600 text-white shadow-inner" : "bg-slate-800 text-slate-500"}`}>{s}x</button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6 custom-scrollbar relative">
                        <div className="max-w-4xl mx-auto pb-16">
                            {notification && (
                                <div className="fixed top-4 right-4 z-50 flex items-center gap-2 px-3 py-2 bg-white border border-indigo-100 rounded-xl shadow-2xl animate-in">
                                    <div className={`w-1.5 h-1.5 rounded-full animate-pulse ${notification.type === 'error' ? 'bg-rose-500' : 'bg-indigo-600'}`}></div>
                                    <span className="font-black text-[9px] text-slate-700 uppercase tracking-tight">{notification.message}</span>
                                </div>
                            )}

                            {activeTab === 0 && (
                                <div className="animate-in">
                                    <SectionHeader title={tabs[0].name} desc={tabs[0].desc} onSyncAI={() => syncEnglish('intro')} />
                                    <div className="grid lg:grid-cols-2 gap-4">
                                        <div className="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm relative">
                                            <span className="text-[8px] font-black text-indigo-500 uppercase mb-3 block bg-indigo-50 w-fit px-2 py-0.5 rounded leading-none">ZH INPUT</span>
                                            <textarea className="w-full h-72 bg-transparent border-none focus:ring-0 text-slate-700 text-sm p-0 resize-none font-bold shadow-inner" value={data.intro.zh} onChange={(e) => setData({...data, intro: {...data.intro, zh: e.target.value}})} />
                                        </div>
                                        <div className="bg-slate-900 p-5 rounded-[2rem] shadow-2xl flex flex-col relative h-72 overflow-hidden">
                                            {(syncTarget === 'intro' || apiStatus === 'blocked') && <LoadingOverlay dark />}
                                            <div className="flex justify-between items-center mb-3 relative z-10">
                                                <span className="text-[8px] font-black text-indigo-400 uppercase tracking-widest leading-none">EN OUTPUT</span>
                                                <button onClick={() => speak(data.intro.en, 'intro')} className="w-7 h-7 bg-white text-slate-900 rounded-full flex items-center justify-center shadow-lg hover:scale-110"><Icon name="play" size={12} fill="currentColor"/></button>
                                            </div>
                                            <div className="text-white/80 italic font-semibold leading-relaxed text-xs overflow-y-auto custom-scrollbar relative z-10 pr-2">
                                                <InteractiveText text={data.intro.en} />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 1 && (
                                <div className="space-y-4 animate-in">
                                    <SectionHeader title={tabs[1].name} desc={tabs[1].desc} onAdd={() => addItem('star')} />
                                    {data.star.map((item, idx) => (
                                        <div key={idx} className="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm space-y-3">
                                            <ItemSubject index={idx} title={item.skill} onChange={(v) => { const nd={...data}; nd.star[idx].skill=v; setData(nd); }} onSync={() => syncEnglish('star', idx)} onDelete={() => deleteItem('star', idx)} />
                                            {['context', 'action', 'result'].map(p => (
                                                <div key={p} className="grid lg:grid-cols-2 gap-3">
                                                    <div className="p-3 bg-slate-50 rounded-2xl border border-slate-100 shadow-inner">
                                                        <span className="text-[7px] font-black text-slate-400 uppercase mb-1.5 block leading-none">{p} (ZH)</span>
                                                        <textarea className="w-full bg-transparent border-none p-0 focus:ring-0 text-slate-600 font-bold leading-relaxed text-[13px]" rows={2} value={item.zh[p]} onChange={(e) => { const nd={...data}; nd.star[idx].zh[p]=e.target.value; setData(nd); }} />
                                                    </div>
                                                    <div className="p-3 bg-indigo-50/40 rounded-2xl flex items-start gap-2 border border-indigo-50 shadow-inner relative overflow-hidden">
                                                        {(syncTarget === `star-${idx}` || apiStatus === 'blocked') && <LoadingOverlay />}
                                                        <button onClick={() => speak(item.en[p], `s-${idx}-${p}`)} className="text-slate-300 hover:text-indigo-600 shrink-0 transition-all p-0.5 mt-0.5"><Icon name="volume-2" size={12}/></button>
                                                        <div className="text-slate-700 italic font-bold leading-relaxed text-[12px]"><InteractiveText text={item.en[p]} /></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            )}

                            {[2, 3].includes(activeTab) && (
                                <div className="space-y-4 animate-in">
                                    <SectionHeader title={tabs[activeTab].name} desc={tabs[activeTab].desc} onAdd={() => addItem(activeTab === 2 ? 'homebase' : 'seei')} />
                                    {(activeTab === 2 ? data.homebase : data.seei).map((item, idx) => (
                                        <div key={idx} className="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm space-y-3">
                                            <ItemSubject index={idx} title={activeTab === 2 ? item.q : item.topic} onChange={(v) => { const nd={...data}; if(activeTab===2) nd.homebase[idx].q=v; else nd.seei[idx].topic=v; setData(nd); }} onSync={() => syncEnglish(activeTab === 2 ? 'homebase' : 'seei', idx)} onDelete={() => deleteItem(activeTab === 2 ? 'homebase' : 'seei', idx)} />
                                            <div className="grid lg:grid-cols-2 gap-3">
                                                <textarea className="w-full h-24 bg-slate-50 p-4 rounded-2xl border border-slate-100 focus:ring-0 text-slate-700 font-bold text-xs resize-none shadow-inner" value={item.zh} onChange={(e) => { const nd={...data}; if(activeTab===2) nd.homebase[idx].zh=e.target.value; else nd.seei[idx].zh=e.target.value; setData(nd); }} />
                                                <div className="bg-slate-900 p-4 rounded-2xl text-white overflow-y-auto h-24 border border-slate-800 pr-2 relative shadow-inner">
                                                    {(syncTarget === `${activeTab === 2 ? 'homebase' : 'seei'}-${idx}` || apiStatus === 'blocked') && <LoadingOverlay dark />}
                                                    <div className="flex justify-between mb-2">
                                                        <span className="text-[7px] font-black text-indigo-400 uppercase leading-none">NARRATIVE (EN)</span>
                                                        <button onClick={() => speak(item.en, `h-${idx}`)} className="text-slate-500 hover:text-white transition-all"><Icon name="play" size={10} fill="currentColor"/></button>
                                                    </div>
                                                    <div className="italic font-semibold text-xs leading-relaxed"><InteractiveText text={item.en} /></div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {activeTab === 4 && (
                                <div className="space-y-3 animate-in">
                                    <SectionHeader title={tabs[4].name} desc={tabs[4].desc} onAdd={() => addItem('reverse_qs')} />
                                    {data.reverse_qs.map((rq, idx) => (
                                        <div key={idx} className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm group">
                                            <ItemSubject index={idx} title={rq.zh} onChange={(v) => { const nd={...data}; nd.reverse_qs[idx].zh=v; setData(nd); }} onSync={() => syncEnglish('reverse_qs', idx)} onDelete={() => deleteItem('reverse_qs', idx)} />
                                            <div className="bg-slate-800 p-3 rounded-xl flex items-center gap-3 border border-slate-700 mt-2 relative overflow-hidden shadow-inner">
                                                {(syncTarget === `reverse_qs-${idx}` || apiStatus === 'blocked') && <LoadingOverlay dark />}
                                                <button onClick={() => speak(rq.en, `rq-${idx}`)} className="shrink-0 text-slate-500 hover:text-white transition-all"><Icon name="mic" size={12}/></button>
                                                <div className="text-white font-medium italic text-[12px] leading-tight"><InteractiveText text={rq.en} /></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {activeTab === 5 && (
                                <div className="space-y-4 animate-in">
                                    <SectionHeader title={tabs[5].name} desc={tabs[5].desc} onSyncAI={generateVocabulary} />
                                    <div className="bg-white rounded-[2rem] border border-slate-200 overflow-hidden shadow-sm divide-y divide-slate-50 max-h-[600px] overflow-y-auto custom-scrollbar relative">
                                        {(syncTarget === 'vocabulary' || apiStatus === 'blocked') && <div className="sticky top-0 w-full z-20"><LoadingOverlay /></div>}
                                        {data.vocabulary.map((v, idx) => (
                                            <div key={idx} className="p-4 flex flex-col md:flex-row items-center gap-5 group hover:bg-slate-50 transition-colors">
                                                <div className="w-full md:w-40 shrink-0">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="text-sm font-black text-slate-900 tracking-tighter uppercase">{v.word}</span>
                                                        <button onClick={() => speak(v.word, `v-${idx}`)} className="text-slate-300 group-hover:text-indigo-600 transition-all"><Icon name="volume-2" size={12}/></button>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-indigo-600 font-black text-[9px] bg-indigo-50 px-2 py-0.5 rounded-lg border border-indigo-100/50 leading-none">{v.zh}</span>
                                                        <button onClick={() => { const nd={...data}; nd.vocabulary.splice(idx,1); setData(nd); }} className="text-rose-200 opacity-0 group-hover:opacity-100 hover:text-rose-500 p-1 transition-all"><Icon name="x" size={12}/></button>
                                                    </div>
                                                </div>
                                                <div className="flex-1 bg-slate-50/50 p-3 rounded-2xl italic text-slate-600 font-bold text-[12px] border border-slate-100 shadow-inner">
                                                    {v.desc}
                                                </div>
                                            </div>
                                        ))}
                                        {data.vocabulary.length === 0 && <div className="p-20 text-center text-slate-300 font-black uppercase text-[10px] tracking-widest">Vocabulary Assets Empty</div>}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASUS PM LAB PRO - Wolf Huang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', 'PingFang TC', 'Microsoft JhengHei', sans-serif; scroll-behavior: smooth; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .interactive-word:hover { background-color: #4f46e5; color: white; border-radius: 4px; }
        .glass-sidebar { background: #0f172a; }
        .ai-loading-overlay { position: absolute; inset: 0; background: rgba(255, 255, 255, 0.85); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); z-index: 50; border-radius: inherit; }
        .dark-ai-loading-overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.9); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); z-index: 50; border-radius: inherit; }
        /* 全域同步遮罩優化 */
        .global-sync-overlay { position: fixed; inset: 0; background: rgba(7, 10, 19, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(20px); }
        .pulse-text { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .progress-bar-container { width: 320px; height: 4px; background: rgba(255, 255, 255, 0.05); border-radius: 20px; margin-top: 32px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.05); }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #4f46e5, #818cf8, #4f46e5); background-size: 200% 100%; animation: gradient Move 2s linear infinite; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 20px rgba(79, 70, 229, 0.6); }
        @keyframes gradientMove { 0% { background-position: 100% 0%; } 100% { background-position: -100% 0%; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden md:overflow-hidden text-sm">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const apiKey = ""; // 如果有預設 Key 可填在此

        const tabsMapping = ["intro", "star", "homebase", "seei", "reverse_qs", "vocabulary"];
        const tabs = [
            { name: "自我介紹", icon: "user", desc: "Core Pitch" },
            { name: "STAR 範例", icon: "star", desc: "Achievements" },
            { name: "困難問題", icon: "shield-alert", desc: "Q&A Defense" },
            { name: "SEE-I 模型", icon: "message-square", desc: "Mental Model" },
            { name: "關鍵反問", icon: "help-circle", desc: "Reverse Qs" },
            { name: "單字庫", icon: "book-open", desc: "Vocab Assets" }
        ];

        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // 音訊轉換輔助 (維持原邏輯)
        function pcmToWav(pcmBase64, sampleRate = 24000) {
            const byteCharacters = atob(pcmBase64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
            const pcmData = new Uint8Array(byteNumbers);
            const buffer = new ArrayBuffer(44 + pcmData.length);
            const view = new DataView(buffer);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); } };
            writeString(0, 'RIFF'); view.setUint32(4, 32 + pcmData.length, true); writeString(8, 'WAVE');
            writeString(12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, pcmData.length, true);
            pcmData.forEach((byte, i) => view.setUint8(44 + i, byte));
            return new Blob([buffer], { type: 'audio/wav' });
        }

        let requestQueue = Promise.resolve();
        let lastRequestTime = 0;
        let globalIsBlocked = false; 
        const MIN_RPM_DELAY = 8000; 

        const App = () => {
            const [activeTab, setActiveTab] = useState(0);
            const [isGenerating, setIsGenerating] = useState(false);
            const [apiStatus, setApiStatus] = useState('idle'); 
            const [cooldownSeconds, setCooldownSeconds] = useState(0);
            const [syncTarget, setSyncTarget] = useState(null); 
            const [isPlaying, setIsPlaying] = useState(null);
            const [notification, setNotification] = useState(null);
            const [playbackSpeed, setPlaybackSpeed] = useState(1.0);
            const [appsScriptUrl, setAppsScriptUrl] = useState("");
            const [sheetUrl, setSheetUrl] = useState("");
            const [userApiKey, setUserApiKey] = useState("");
            
            const [isGlobalSyncing, setIsGlobalSyncing] = useState(false);
            const [syncProgress, setSyncProgress] = useState({ current: 0, total: 6, label: "" });

            const [systemPrompt, setSystemPrompt] = useState(
                "你是一位資深的 ASUS 全球電商 PM。你的任務是提供翻譯。嚴禁任何前言、解釋或引號。直接輸出翻譯後的原始文字。語氣精煉、具執行力。單字釋義必須使用「繁體中文」。"
            );

            const [data, setData] = useState({
                intro: { zh: "", en: "" },
                star: [],
                homebase: [],
                seei: [],
                reverse_qs: [],
                vocabulary: []
            });

            const notify = (msg, type = 'success') => { setNotification({ message: msg, type }); setTimeout(() => setNotification(null), 5000); };

            // API 請求邏輯與狀態管理
            const askAI = async (prompt, asJson = false) => {
                if (globalIsBlocked) throw new Error(`API 冷卻鎖定中，請等候 ${cooldownSeconds} 秒。`);
                const executeRequest = async () => {
                    const now = Date.now();
                    const wait = Math.max(0, MIN_RPM_DELAY - (now - lastRequestTime));
                    if (wait > 0) await new Promise(r => setTimeout(r, wait));
                    setApiStatus('processing');
                    const finalKey = userApiKey || apiKey;
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${finalKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: asJson ? { responseMimeType: "application/json" } : {}
                    };
                    try {
                        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        lastRequestTime = Date.now();
                        if (res.status === 429) {
                            globalIsBlocked = true;
                            setApiStatus('blocked');
                            setCooldownSeconds(60); 
                            throw new Error("偵測到 429 頻率限制：系統熔斷冷卻中。");
                        }
                        if (res.ok) {
                            const result = await res.json();
                            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (text) {
                                setApiStatus('idle');
                                return text.replace(/```json|```/g, "").trim();
                            }
                            throw new Error("AI 回傳內容無效");
                        }
                        const errorData = await res.json();
                        throw new Error(errorData.error?.message || `Error ${res.status}`);
                    } catch (e) {
                        if (!e.message.includes("429")) setApiStatus('idle');
                        throw e;
                    }
                };
                return new Promise((resolve, reject) => {
                    requestQueue = requestQueue.catch(() => {}).then(async () => {
                        try { const result = await executeRequest(); resolve(result); } catch (err) { reject(err); }
                    });
                });
            };

            const syncEnglish = async (section, index = null) => {
                if (apiStatus === 'blocked') return notify(`API 熔斷中，請稍候 ${cooldownSeconds} 秒`, "error");
                const targetId = index !== null ? `${section}-${index}` : section;
                if (isGenerating) return; 
                setIsGenerating(true);
                setSyncTarget(targetId);
                let prompt = "";
                const isStar = section === 'star';
                try {
                    const currentSection = data[section];
                    if (section === 'intro') prompt = `Translate to business English (DIRECT CONTENT ONLY): ${currentSection.zh}`;
                    else if (isStar) prompt = `Translate STAR to business English JSON. Keys: context, action, result. Input: ${JSON.stringify(currentSection[index].zh)}`;
                    else if (section === 'homebase' || section === 'seei') prompt = `Translate to business English (DIRECT CONTENT ONLY): ${currentSection[index].zh}`;
                    else if (section === 'reverse_qs') prompt = `Translate to professional English (DIRECT CONTENT ONLY): ${currentSection[index].zh}`;
                    const text = await askAI(prompt, isStar);
                    const newData = { ...data };
                    if (section === 'intro') newData.intro.en = text;
                    else if (isStar) {
                        const clean = text.match(/\{[\s\S]*\}/)?.[0] || text;
                        newData.star[index].en = JSON.parse(clean);
                    }
                    else if (section === 'homebase') newData.homebase[index].en = text;
                    else if (section === 'seei') newData.seei[index].en = text;
                    else if (section === 'reverse_qs') newData.reverse_qs[index].en = text;
                    setData(newData); notify("AI 同步成功");
                } catch (e) { notify(e.message, "error"); } finally { setIsGenerating(false); setSyncTarget(null); }
            };

            // GAS 同步邏輯
            const handlePull = async (section) => {
                if (!appsScriptUrl) return null;
                try {
                    const response = await fetch(`${appsScriptUrl}?action=pull&section=${section}`);
                    if (!response.ok) throw new Error("Fetch failed");
                    return await response.json();
                } catch (e) {
                    console.error(`Pull Error (${section}):`, e);
                    return null;
                }
            };

            const pullAll = async () => {
                if (!appsScriptUrl) return notify("請輸入 GAS URL", "error");
                setIsGlobalSyncing(true);
                const tempNewData = { ...data };
                let successCount = 0;
                try {
                    for (let i = 0; i < tabsMapping.length; i++) {
                        const section = tabsMapping[i];
                        const sectionLabel = tabs[i]?.name || section;
                        setSyncProgress({ current: i + 1, total: tabsMapping.length, label: sectionLabel });
                        const cloudData = await handlePull(section);
                        if (cloudData) {
                            tempNewData[section] = cloudData;
                            successCount++;
                        }
                        await new Promise(r => setTimeout(r, 400));
                    }
                    setData(tempNewData);
                    notify(`全域同步成功 (${successCount}/${tabsMapping.length})`);
                } catch (e) {
                    notify("同步過程發生錯誤", "error");
                } finally { setIsGlobalSyncing(false); }
            };

            const handlePush = async () => {
                if (!appsScriptUrl) return notify("請輸入 GAS URL", "error");
                const section = tabsMapping[activeTab];
                notify(`上傳 ${section} 中...`, "info");
                try {
                    await fetch(appsScriptUrl, { 
                        method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ action: "push", section, data: data[section] }) 
                    });
                    notify("雲端存檔指令已發送");
                } catch (e) { notify("上傳失敗", "error"); }
            };

            const speak = async (text, id) => {
                const finalKey = userApiKey || apiKey;
                if (!finalKey || !text || isPlaying) return;
                setIsPlaying(id);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${finalKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: `Say clearly: ${text}` }] }], 
                            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } },
                            model: "gemini-2.5-flash-preview-tts"
                        })
                    });
                    const result = await res.json();
                    const pcm = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (pcm) {
                        const wav = pcmToWav(pcm); 
                        const audio = new Audio(URL.createObjectURL(wav));
                        audio.playbackRate = playbackSpeed; audio.onended = () => setIsPlaying(null); audio.play();
                    } else { setIsPlaying(null); }
                } catch (e) { setIsPlaying(null); }
            };

            // 組件渲染優化
            const SectionHeader = ({ title, desc, onSyncAI, onAdd }) => (
                <div className="mb-4 bg-white p-3 rounded-2xl border border-slate-200 shadow-sm animate-in flex flex-col md:flex-row md:items-center justify-between gap-2 shrink-0">
                    <div className="flex items-center gap-2">
                        <div className="w-1 h-5 bg-indigo-600 rounded-full"></div>
                        <div>
                            <h2 className="text-base font-black text-slate-800 tracking-tighter uppercase italic leading-none">{title}</h2>
                            <p className="text-[8px] text-slate-400 font-bold uppercase tracking-widest mt-1.5">{desc}</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-1.5">
                        {onAdd && <button onClick={onAdd} className="bg-slate-900 text-white px-2.5 py-1.5 rounded-lg text-[9px] font-black flex items-center gap-1 hover:bg-slate-800 active:scale-95 shadow-sm mr-1"><Icon name="plus" size={10}/> ADD</button>}
                        <button onClick={() => handlePull(tabsMapping[activeTab]).then(d => d && setData(p => ({...p, [tabsMapping[activeTab]]: d})))} className="bg-white border border-slate-200 text-slate-500 px-2.5 py-1.5 rounded-lg text-[9px] font-black flex items-center gap-1 hover:bg-slate-50 shadow-sm"><Icon name="download-cloud" size={10}/> PULL</button>
                        <button onClick={handlePush} className="bg-white border border-slate-200 text-indigo-600 px-2.5 py-1.5 rounded-lg text-[9px] font-black flex items-center gap-1 hover:bg-indigo-50 shadow-sm"><Icon name="upload-cloud" size={10}/> PUSH</button>
                        {onSyncAI && <button disabled={isGenerating || apiStatus === 'blocked'} onClick={onSyncAI} className={`px-3 py-1.5 rounded-lg shadow-md text-[9px] font-black flex items-center gap-1 transition-all ${apiStatus === 'blocked' ? 'bg-rose-100 text-rose-500' : (isGenerating ? 'bg-slate-100' : 'bg-indigo-600 text-white')}`}><Icon name={apiStatus === 'blocked' ? "alert-triangle" : "sparkles"} size={10}/> {apiStatus === 'blocked' ? `LOCK (${cooldownSeconds}s)` : 'AI SYNC'}</button>}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen md:h-screen flex flex-col md:flex-row bg-slate-50 overflow-x-hidden md:overflow-hidden shrink-0">
                    
                    {/* 優化後的全系統凍結遮罩 */}
                    {isGlobalSyncing && (
                        <div className="global-sync-overlay animate-in">
                            <div className="relative mb-10">
                                <div className="absolute inset-0 bg-indigo-500/10 blur-3xl rounded-full"></div>
                                <Icon name="cloud-download" size={64} className="text-indigo-500 spin-slow relative z-10" />
                            </div>
                            
                            <div className="text-center">
                                <h3 className="text-white font-black text-xl uppercase tracking-[0.3em] leading-none mb-4">Intel Sync Lock</h3>
                                <div className="flex items-center justify-center gap-3">
                                    <span className="h-px w-6 bg-slate-800"></span>
                                    <p className="text-indigo-400 font-bold text-[11px] uppercase tracking-widest italic">
                                        Module: {syncProgress.label} ({syncProgress.current} / {syncProgress.total})
                                    </p>
                                    <span className="h-px w-6 bg-slate-800"></span>
                                </div>
                            </div>

                            <div className="progress-bar-container relative">
                                <div className="progress-bar-fill" style={{ width: `${(syncProgress.current / syncProgress.total) * 100}%` }}></div>
                                <span className="absolute -bottom-5 right-0 text-[9px] font-black text-slate-600">
                                    {Math.round((syncProgress.current / syncProgress.total) * 100)}% COMPLETE
                                </span>
                            </div>

                            <div className="mt-14 flex flex-col items-center gap-5">
                                <div className="flex gap-2.5">
                                    {tabsMapping.map((_, idx) => (
                                        <div key={idx} className={`w-2 h-2 rounded-full transition-all duration-700 ${idx < syncProgress.current ? 'bg-indigo-500 shadow-[0_0_12px_rgba(79,70,229,1)]' : 'bg-slate-900'}`}></div>
                                    ))}
                                </div>
                                <span className="text-slate-700 text-[9px] uppercase font-black tracking-[0.5em] animate-pulse">System Data Integrity Protected</span>
                            </div>
                        </div>
                    )}

                    <nav className="w-full md:w-56 glass-sidebar text-slate-400 p-3 flex flex-col h-fit md:h-full z-20 shrink-0 shadow-2xl">
                        <div className="mb-3 flex items-center justify-between px-1 shrink-0">
                            <h1 className="text-base font-black text-white tracking-tighter uppercase leading-none">ASUS PM<br/><span className="text-indigo-500 text-[10px] tracking-[0.2em]">LAB PRO</span></h1>
                            <button onClick={pullAll} className="bg-indigo-600/20 text-indigo-400 p-1.5 rounded-lg hover:bg-indigo-600/40 border border-indigo-500/20 transition-all"><Icon name="refresh-cw" size={12}/></button>
                        </div>

                        <div className="space-y-1.5 mb-4 shrink-0">
                            <input type="password" placeholder="API Key" className="w-full bg-slate-800 text-[9px] py-1.5 pl-3 rounded-lg border border-slate-700 text-white outline-none" value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} />
                            <input type="text" placeholder="GAS URL" className="w-full bg-slate-800 text-[9px] py-1.5 pl-3 rounded-lg border border-slate-700 text-white outline-none" value={appsScriptUrl} onChange={(e) => setAppsScriptUrl(e.target.value)} />
                            
                            {/* 增加 Google Sheet 跳轉按鈕 */}
                            <div className="relative group">
                                <input type="text" placeholder="Sheet URL" className="w-full bg-slate-800 text-[9px] py-1.5 pl-3 pr-8 rounded-lg border border-slate-700 text-white outline-none" value={sheetUrl} onChange={(e) => setSheetUrl(e.target.value)} />
                                {sheetUrl && (
                                    <a href={sheetUrl} target="_blank" className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-indigo-400 transition-colors">
                                        <Icon name="external-link" size={10} />
                                    </a>
                                )}
                            </div>
                            {sheetUrl && (
                                <button onClick={() => window.open(sheetUrl, '_blank')} className="w-full bg-slate-700/30 hover:bg-indigo-600/20 text-slate-400 hover:text-indigo-300 text-[8px] font-black py-1.5 rounded-lg transition-all flex items-center justify-center gap-1.5 uppercase tracking-widest border border-slate-700/50">
                                    <Icon name="table" size={10} /> Open Sheet
                                </button>
                            )}
                        </div>

                        <div className="flex-1 space-y-0.5 overflow-y-auto custom-scrollbar pr-0.5">
                            {tabs.map((tab, idx) => (
                                <button key={idx} onClick={() => setActiveTab(idx)} className={`w-full flex items-center gap-2 px-2.5 py-1.5 rounded-xl transition-all ${activeTab === idx ? "bg-indigo-600 text-white shadow-inner scale-[1.02]" : "hover:bg-slate-800 hover:text-slate-200"}`}>
                                    <Icon name={tab.icon} size={13} />
                                    <span className="font-black text-[9px] uppercase tracking-widest">{tab.name}</span>
                                </button>
                            ))}
                        </div>
                    </nav>

                    <main className="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6 custom-scrollbar relative">
                        {/* 內容區塊邏輯維持原狀，僅 activeTab 0 ~ 5 的組件渲染 */}
                        {activeTab === 0 && (
                            <div className="max-w-4xl mx-auto animate-in">
                                <SectionHeader title={tabs[0].name} desc={tabs[0].desc} onSyncAI={() => syncEnglish('intro')} />
                                <div className="grid lg:grid-cols-2 gap-4">
                                    <div className="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm relative">
                                        <span className="text-[8px] font-black text-indigo-500 uppercase mb-3 block bg-indigo-50 w-fit px-2 py-0.5 rounded leading-none">ZH INPUT</span>
                                        <textarea className="w-full h-72 bg-transparent border-none focus:ring-0 text-slate-700 text-sm p-0 resize-none font-bold shadow-inner" value={data.intro.zh} onChange={(e) => setData({...data, intro: {...data.intro, zh: e.target.value}})} />
                                    </div>
                                    <div className="bg-slate-900 p-5 rounded-[2rem] shadow-2xl flex flex-col relative h-72 overflow-hidden">
                                        {(syncTarget === 'intro' || apiStatus === 'blocked') && <div className="dark-ai-loading-overlay"><Icon name="sparkles" size={24} className="text-indigo-500 spin-slow"/><span className="text-white text-[9px] font-black ml-2 uppercase pulse-text">Computing...</span></div>}
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="text-[8px] font-black text-indigo-400 uppercase tracking-widest leading-none">EN OUTPUT</span>
                                            <button onClick={() => speak(data.intro.en, 'intro')} className="w-7 h-7 bg-white text-slate-900 rounded-full flex items-center justify-center shadow-lg hover:scale-110"><Icon name="play" size={12} fill="currentColor"/></button>
                                        </div>
                                        <div className="text-white/80 italic font-semibold leading-relaxed text-xs overflow-y-auto custom-scrollbar pr-2">
                                            {data.intro.en || "Awaiting AI Analysis..."}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* 其他分頁維持原邏輯，此處僅示範分頁 0 ... */}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
